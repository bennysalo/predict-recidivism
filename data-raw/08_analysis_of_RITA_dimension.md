Predicting recidivism in test set based on models trained on training set
================
Benny Salo
2018-07-19

These analyses examines the incremental predictive validity of factor sum scores over the predictions rendered via the static predictors.

We do analyses for predictions of both general and violent recidivism. For each, we run two sets of logistic regressions. First, we run univariate logistic regression analyses to examine the predictive power of the sum variables - on regression for each sum variable. Second, we run one logistic regression per sum variable where we also control for the predictions based on static predictors.

We do this in the test set. Thus, the predictions based on static predictors can be considered to not be overfitted. The predictions are converted into logits for the purpose of the logistic regression analysis.

We can, thus, categorize the analyses as six (one per sum variable) hierarchical logistic regressions. (In fact we should consider presenting the results per sum variable rather than by type of predictor set (univariate vs. with covariate)).

An alternative would be to also avoid overfitting for the sum variables by determining training logistic regression models in the training set and then predicting outcomes in the test set.

``` r
library(dplyr)
devtools::load_all(".")
```

``` r
rm(list = ls())
devtools::wd()
predictions_and_RITAsums <- readRDS("not_public/predictions_and_RITAsums.rds")
```

Data to analyse
---------------

``` r
dim_analysis_data <-
  predictions_and_RITAsums %>%
  # Select:
  select(
    # The outcome variables
    reoffenceThisTerm, newO_violent,
    # The 6 sum scores
    1:6,
    # The predictions based on static predictors using elastic net
    gen_stat_glmnet, vio_stat_glmnet) %>%
  # Create new vairables
  mutate(
    # Logit for predictions of general recidivism
    gen_stat_glmnet_logit = log(gen_stat_glmnet / (1 - gen_stat_glmnet)),
    # Logit for predictions of violent recidivism
    vio_stat_glmnet_logit = log(vio_stat_glmnet / (1 - vio_stat_glmnet))) %>%
  # Scale all variables except the outcome variables
  mutate_at(.vars = vars(-reoffenceThisTerm, -newO_violent), scale)
 
rm(predictions_and_RITAsums)
```

### Assertions

Make sure variables are scaled and centered

``` r
sds_that_should_be_1 <- dim_analysis_data %>%
  select(-reoffenceThisTerm, -newO_violent) %>% 
  purrr::map_dbl(sd)

means_that_should_be_0 <- dim_analysis_data %>%
  select(-reoffenceThisTerm, -newO_violent) %>% 
  purrr::map_dbl(mean)

stopifnot(all(round(sds_that_should_be_1, 10) == 1))
stopifnot(all(round(means_that_should_be_0, 10) == 0))
```

### Functions

Run a set of logistic regression models. Arguments:

-   `predictors`: a character vector of predictor names. On model will be fitted per predictor
-   `ouctome`: character stiring indicating the outcome. Will be the same for all models.
-   `control_var`: optional. character sting indicating the control variable

``` r
run_glm_mods <- function(predictors, outcome, control_var = NULL,
                              d_frame = dim_analysis_data) {
  
  my_formulas <-
    purrr::map(.x = predictors,
               .f = ~ write_formula(lhs = outcome, rhs = c(control_var, .x)))
  
  my_mod_fits <-
    purrr::map(.x = my_formulas,
               .f = ~ glm(formula = .x,
                          family  = binomial,
                          data    = d_frame))
  
  names(my_mod_fits) <- predictors
  
  return(my_mod_fits) 
}
```

Function for getting the statistics that are to be displayed in table.

\*Arguments: - `glm_model`: a fitted model generated by `glm` - `x_of_interest`: the predictor that we are interested in and want statisics for.

``` r
get_key_mod_stats <- function(glm_model, x_of_interest) {
  coef_table  <- summary(glm_model)$coefficients
  anova_table <- anova(glm_model, test = "Chisq")
  
  
  beta   <- coef_table[x_of_interest, "Estimate"]
  SE     <- coef_table[x_of_interest, "Std. Error"]
  
  chi_sq <- anova_table[x_of_interest, "Deviance"]
  p      <- anova_table[x_of_interest, "Pr(>Chi)"]
  
  return(data_frame(beta = beta, SE = SE, chi_sq = chi_sq, p = p))
}
```

Make a table of the model stats. Apply `get_key_mod_stats`to all fitted model in the list.

-   Argument: The list of model fits generated by `run_glm_mods`. Should have model names as element names.
-   Value: A table with model stats per model.

``` r
get_mod_stats <- function(list_of_fits) {
  xs_of_interest <- names(list_of_fits)
  
  my_table <- 
    purrr::map2_df(.x = list_of_fits,
                   .y = xs_of_interest,
                   .f = ~get_key_mod_stats(glm_model = .x,
                                           x_of_interest = .y)
                   )
  my_table <- bind_cols(data_frame(predictor = xs_of_interest),
                        my_table)
  
  return(my_table)
} 
```

Edit table to a more print friendly form

``` r
edit_stats_table <- function(my_table) {
  my_table %>%
    mutate_at(.vars = vars(beta, SE), round, 2) %>%
    mutate_at(.vars = vars(chi_sq), round, 1) %>%
    mutate_at(.vars = vars(p), round, 3) %>%
    mutate_at(.vars = vars(p), as.character) %>%
    mutate(p = ifelse(p == 0, "> 0.001", p))
}
```

Put it all together

``` r
get_mod_stats_tbl  <- function(predictors, outcome, control_var = NULL,
                               d_frame = dim_analysis_data) {
  glm_mod_fits <- 
    run_glm_mods(predictors  = predictors,
                 control_var = control_var,
                 outcome     = outcome)
  
  pred_tbl     <- purrr::map_df(glm_mod_fits, predict.glm, type = "response") 
  auc_vector   <- 
    purrr::map_dbl(.x = pred_tbl, 
                   .f = ~pROC::auc(d_frame[[outcome]], .x))
  
  stats_table  <- get_mod_stats(glm_mod_fits)
  stats_table  <- bind_cols(stats_table, data_frame(auc = auc_vector))
  
  knitr::kable(edit_stats_table(stats_table))
}
```

Analyses
--------

``` r
sum_vars       <- stringr::str_subset(names(dim_analysis_data), "^sum_")
```

### General recidivism. Univariate analyses.

``` r
get_mod_stats_tbl(predictors = c(sum_vars, "gen_stat_glmnet_logit"),
                  outcome    = "reoffenceThisTerm")
```

| predictor                 |  beta|    SE|  chi\_sq| p          |        auc|
|:--------------------------|-----:|-----:|--------:|:-----------|----------:|
| sum\_economy\_problems    |  0.66|  0.12|     35.9| &gt; 0.001 |  0.6780005|
| sum\_alcohol\_problems    |  0.57|  0.11|     28.0| &gt; 0.001 |  0.6538649|
| sum\_resistance\_change   |  0.25|  0.11|      5.5| 0.019      |  0.5759816|
| sum\_drug\_related\_probl |  0.77|  0.12|     47.1| &gt; 0.001 |  0.7110727|
| sum\_aggressiveness       |  0.51|  0.11|     21.9| &gt; 0.001 |  0.6475307|
| sum\_employment\_probl    |  0.63|  0.12|     33.2| &gt; 0.001 |  0.6709657|
| gen\_stat\_glmnet\_logit  |  1.27|  0.16|     93.9| &gt; 0.001 |  0.7850096|

### General recidivism. Controlled for static predictions.

``` r
get_mod_stats_tbl(predictors  = sum_vars,
                  control_var = "gen_stat_glmnet_logit",
                  outcome     = "reoffenceThisTerm")
```

| predictor                 |  beta|    SE|  chi\_sq| p     |        auc|
|:--------------------------|-----:|-----:|--------:|:------|----------:|
| sum\_economy\_problems    |  0.40|  0.13|     10.0| 0.002 |  0.7959907|
| sum\_alcohol\_problems    |  0.34|  0.12|      7.7| 0.006 |  0.7918442|
| sum\_resistance\_change   |  0.09|  0.12|      0.6| 0.443 |  0.7840087|
| sum\_drug\_related\_probl |  0.32|  0.14|      5.6| 0.018 |  0.7903286|
| sum\_aggressiveness       |  0.26|  0.12|      4.4| 0.036 |  0.7848666|
| sum\_employment\_probl    |  0.22|  0.13|      2.9| 0.088 |  0.7880408|

### Univariate analyses, violent recidivism.

``` r
get_mod_stats_tbl(predictors = c(sum_vars, "vio_stat_glmnet_logit"),
                  outcome    = "newO_violent")
```

| predictor                 |  beta|    SE|  chi\_sq| p          |        auc|
|:--------------------------|-----:|-----:|--------:|:-----------|----------:|
| sum\_economy\_problems    |  0.45|  0.13|     11.4| 0.001      |  0.6346527|
| sum\_alcohol\_problems    |  0.62|  0.14|     20.6| &gt; 0.001 |  0.6805825|
| sum\_resistance\_change   |  0.23|  0.13|      3.1| 0.077      |  0.5830719|
| sum\_drug\_related\_probl |  0.51|  0.14|     13.8| &gt; 0.001 |  0.6483694|
| sum\_aggressiveness       |  0.76|  0.14|     31.9| &gt; 0.001 |  0.7357730|
| sum\_employment\_probl    |  0.45|  0.13|     11.8| 0.001      |  0.6267862|
| vio\_stat\_glmnet\_logit  |  1.05|  0.16|     50.7| &gt; 0.001 |  0.7791884|

### Violent recidivism. Controlled for static predictions.

``` r
get_mod_stats_tbl(predictors  = sum_vars,
               control_var = "vio_stat_glmnet_logit",
               outcome     = "newO_violent")
```

| predictor                 |  beta|    SE|  chi\_sq| p          |        auc|
|:--------------------------|-----:|-----:|--------:|:-----------|----------:|
| sum\_economy\_problems    |  0.23|  0.15|      2.4| 0.118      |  0.7897934|
| sum\_alcohol\_problems    |  0.52|  0.15|     12.0| 0.001      |  0.7999502|
| sum\_resistance\_change   |  0.03|  0.14|      0.1| 0.82       |  0.7804829|
| sum\_drug\_related\_probl |  0.09|  0.16|      0.3| 0.566      |  0.7825243|
| sum\_aggressiveness       |  0.58|  0.15|     15.3| &gt; 0.001 |  0.8132437|
| sum\_employment\_probl    |  0.20|  0.15|      1.7| 0.189      |  0.7834703|

### Print sessionInfo

``` r
sessionInfo()
```

    ## R version 3.5.1 (2018-07-02)
    ## Platform: x86_64-w64-mingw32/x64 (64-bit)
    ## Running under: Windows 10 x64 (build 17134)
    ## 
    ## Matrix products: default
    ## 
    ## locale:
    ## [1] LC_COLLATE=Swedish_Finland.1252  LC_CTYPE=Swedish_Finland.1252   
    ## [3] LC_MONETARY=Swedish_Finland.1252 LC_NUMERIC=C                    
    ## [5] LC_TIME=Swedish_Finland.1252    
    ## 
    ## attached base packages:
    ## [1] stats     graphics  grDevices utils     datasets  methods   base     
    ## 
    ## other attached packages:
    ## [1] bindrcpp_0.2.2          recidivismsl_0.0.0.9000 dplyr_0.7.6            
    ## 
    ## loaded via a namespace (and not attached):
    ##  [1] magic_1.5-8        ddalpha_1.3.4      tidyr_0.8.1       
    ##  [4] sfsmisc_1.1-2      splines_3.5.1      foreach_1.4.4     
    ##  [7] prodlim_2018.04.18 assertthat_0.2.0   highr_0.7         
    ## [10] stats4_3.5.1       DRR_0.0.3          yaml_2.1.19       
    ## [13] robustbase_0.93-1  ipred_0.9-6        pillar_1.2.3      
    ## [16] backports_1.1.2    lattice_0.20-35    glue_1.2.0        
    ## [19] pROC_1.12.1        digest_0.6.15      colorspace_1.3-2  
    ## [22] recipes_0.1.3      htmltools_0.3.6    Matrix_1.2-14     
    ## [25] plyr_1.8.4         psych_1.8.4        timeDate_3043.102 
    ## [28] pkgconfig_2.0.1    devtools_1.13.6    CVST_0.2-2        
    ## [31] broom_0.4.5        caret_6.0-80       purrr_0.2.5       
    ## [34] scales_0.5.0       gower_0.1.2        lava_1.6.2        
    ## [37] tibble_1.4.2       ggplot2_3.0.0      withr_2.1.2       
    ## [40] nnet_7.3-12        lazyeval_0.2.1     mnormt_1.5-5      
    ## [43] survival_2.42-3    magrittr_1.5       memoise_1.1.0     
    ## [46] evaluate_0.10.1    nlme_3.1-137       MASS_7.3-50       
    ## [49] xml2_1.2.0         dimRed_0.1.0       foreign_0.8-70    
    ## [52] class_7.3-14       ggthemes_3.5.0     tools_3.5.1       
    ## [55] stringr_1.3.1      kernlab_0.9-26     munsell_0.5.0     
    ## [58] pls_2.6-0          compiler_3.5.1     RcppRoll_0.3.0    
    ## [61] rlang_0.2.1        grid_3.5.1         iterators_1.0.9   
    ## [64] rmarkdown_1.10     testthat_2.0.0     geometry_0.3-6    
    ## [67] gtable_0.2.0       ModelMetrics_1.1.0 codetools_0.2-15  
    ## [70] abind_1.4-5        roxygen2_6.0.1     reshape2_1.4.3    
    ## [73] R6_2.2.2           lubridate_1.7.4    knitr_1.20        
    ## [76] bindr_0.1.1        commonmark_1.5     rprojroot_1.3-2   
    ## [79] stringi_1.1.7      parallel_3.5.1     Rcpp_0.12.17      
    ## [82] rpart_4.1-13       DEoptimR_1.0-8     tidyselect_0.2.4
