---
title: "Data used for this project"
author: "Benny Salo"
date: "`r format(Sys.Date())`"
output: rmarkdown::html_vignette
---


```{r}
library(dplyr)
```

Load raw data. At this point we are not authorized to make raw data publicly available. `FinPrisonMales.rds` includes only males.

```{r message=FALSE, warning=FALSE}
rm(list = ls())
devtools::wd()
FinPrisonMales <- 
  readRDS("not_public/FinPrisonMales.rds")
```

We define a violent crime as crimes that belong to the homicide or assault categories. Other offence categories include offences that are violent and offences that are not violent. In many cases the violent forms are also coded as assault. 

We create variables for new violent crime

```{r}
analyzed_data <- 
  FinPrisonMales %>% 
  mutate(newO_violent = as.factor(ifelse(newO_homicide == 1 | newO_assault == 1, 
                                         "new_violent_crime", 
                                         "no_crime_or_not_violent")),
         newO_violent = relevel(newO_violent, ref ="no_crime_or_not_violent"))


table(analyzed_data$newO_violent)
table(analyzed_data$newO_violent)/nrow(analyzed_data)
```

Of the 748 new convictions 278 are categorized as prison terms for violent crimes.

# Check follow-up time

Compare distributions in follow-up time between those who committed a new crime and those who did not.

```{r}
followUp_G_yes <- analyzed_data[
  analyzed_data$reoffenceThisTerm == "new_prison_sentence",
  "followUpYears"]

followUp_G_no <- analyzed_data[
  analyzed_data$reoffenceThisTerm == "not_in_prison",
  "followUpYears"]

followUp_V_yes <- analyzed_data[
  analyzed_data$newO_violent == "new_violent_crime",
  "followUpYears"]

followUp_V_no <- analyzed_data[
  analyzed_data$newO_violent == "no_crime_or_not_violent",
  "followUpYears"]
  
  
qqplot(followUp_G_yes, followUp_G_no)
qqplot(followUp_V_yes, followUp_V_no)
```

The similarity of distributions is close to perfect for general recidivism and very good for violent recidivism.

Check means and standard deviations

```{r}
analyzed_data %>% 
  group_by(reoffenceThisTerm) %>% 
  summarise(M = mean(followUpYears),
            SD = sd(followUpYears))

analyzed_data %>% 
  group_by(newO_violent) %>% 
  summarise(M = mean(followUpYears),
            SD = sd(followUpYears))

```

# Define predictor sets
```{r}

# Current offences
offence_variables <-
  c("o_traffic", "o_assault", "o_homicide", "o_sexual", "o_otherPerson",
    "o_robbery", "o_theft", "o_autoTheft", "o_otherProperty",
    "o_whitecollar", "o_narcotic", "o_damage", "o_againstOfficer",
    "o_weapon", "o_other")

# Static predictors as used in training
static_preds <-
  c("ageFirstSentence_mr", "ageFirst_missing", "ageAtRelease",
    "ps_escapeHistory", "ps_prisonTerms_mr", "ps_comServiceTerms_mr",
    "ps_remandTerms_mr", "ps_defaultTerms_mr", "ps_info_missing",
    offence_variables)

# Dynamic predictors
(rita_items <-
    stringr::str_subset(names(analyzed_data), "^i_"))

static_n_rita <- c(static_preds, rita_items)

incl_term <- c(static_preds, rita_items,
               "openPrison", "conditionalReleaseOutcome",
               "crimeDuringSentence", "supervisedParole")

# Combined vector of all variables: outcomes and predictors
all_variables  <- c(incl_term, "reoffenceThisTerm", "newO_violent")

#Make sets of variables part of the package
devtools::use_data(static_preds, overwrite = TRUE)
devtools::use_data(rita_items, overwrite = TRUE)
devtools::use_data(incl_term, overwrite = TRUE)

```

Only include the variables we will need
```{r}
analyzed_data <- analyzed_data[all_variables]
```



# Split data into a training set and a test set

```{r}
set.seed(3010)
four_folds   <- caret::createFolds(y = analyzed_data$reoffenceThisTerm, k = 4)

training_set <- analyzed_data[!(1:nrow(analyzed_data) %in% four_folds[[4]]), ]
test_set     <- analyzed_data[ (1:nrow(analyzed_data) %in% four_folds[[4]]), ]

nrow(training_set)
nrow(test_set)

```


# Save data for later use. 
Will not be made public.
```{r message=FALSE, warning=FALSE}
devtools::wd()
saveRDS(analyzed_data, "not_public/analyzed_data.rds")
saveRDS(training_set, "not_public/training_set.rds")
saveRDS(test_set,     "not_public/test_set.rds")
```





