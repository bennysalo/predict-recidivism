---
title: "Training models"
output: github_document
date: 2017-11-07
---

# Setup

Load packages

```{r}
library(caret)
library(tidyverse)
library(pROC)
library(stringr)
library(lavaan)
```

# Load data. 
Exclusion criteria are descibed in data-raw/analyzed_data.md. We are not authorized to make raw data publicly available and the data loaded here is unfortunately not publicly accessible.

```{r message=FALSE, warning=FALSE}
rm(list = ls())
setwd("..")
analyzed_data <- 
  readRDS("data-raw/analyzed_data.rds")
```
These are the 15 categories for the current offence. They are included in the static predictors.

```{r}

(offence_variables <- 
  stringr::str_subset(names(analyzed_data), "^o_"))

# Static predictors as used in training
static_preds <- 
   c("ageFirstSentence_mr", "ageFirst_missing", "ageAtRelease", 
     "ps_escapeHistory", "ps_prisonTerms_mr", "ps_comServiceTerms_mr", 
     "ps_remandTerms_mr", "ps_defaultTerms_mr", "ps_info_missing", 
     offence_variables)

# Dynamic predictors
(rita_items <- 
  stringr::str_subset(names(analyzed_data), "^i_"))

static_n_rita <- c(static_preds, rita_items)

incl_term <- c(static_preds, rita_items, 
               "openPrison", "conditionalReleaseOutcome", 
               "crimeDuringSentence", "supervisedParole")

# Combined vector of all variables: outcomes and predictors
all_variables  <- c(incl_term, "reoffenceThisTerm", "newO_violent")

```

# Create a data frame of all the combinations for the models


```{r}
model_type <- c("glm", "glmnet", "rf")
outcomes   <- c("reoffenceThisTerm", "newO_violent")
predictors <- c("static_preds", "rita_items","static_n_rita", "incl_term")
model_grid <- expand.grid(model_type, outcomes, predictors, 
                         stringsAsFactors = FALSE)
colnames(model_grid) <- c("model_type", "outcome", "predictors")
```

Create a function for writing formulas used in `caret::train`
```{r}
write_formula <- function(outcome, predictors) {
  rhs            <- eval(parse(text = model_grid$predictors))
  tested_formula <- as.formula(paste(outcome, " ~ ", 
                                     paste(rhs, collapse = " + ")))
  return(tested_formula)
}
```



```{r}
model_grid$tested_formula <-
  purrr::map2(
    .x = model_grid$outcome,
    .y = model_grid$predictors,
    .f = ~ write_formula(.x, .y
    )
  )
  
```


```{r}
model_grid$n_preds <-
  purrr::map_int(
    .x = model_grid$predictors,
    .f = ~ length(eval(parse(text = .x)))
    )
  
  
```


Add list of arguments to use with `caret::train`
```{r}
write_arg_list <- function(model_type, outcome, predictors) {
  if (model_type == "glm") {
    specific_args <- list(trControl = myControl,
                          metric    = "ROC",
                          x         = training_set[predictors],
                          y         = training_set[[outcome]],
                          method = "glm",
                          family = "binomial")
  } else if (model_type == "glmnet") {
    specific_args <- list(trControl = myControl,
                          metric    = "ROC",
                          form      = write_formula(outcome, predictors),
                          data      = training_set,
                          family    = "binomial",
                          standardize = TRUE,
                          tuneGrid = expand.grid(
                            alpha  = c(0, 0.2, 0.4, 0.6, 0.8, 1),
                            lambda = seq(0, 3, by = 0.02)))
  } else if (model_type == "rf") {
    # m_try sequency depending on number of predictors
    # includes sqrt() (i.e. 4/8), other powers are 1/8 increments
    n_preds <- length(eval(parse(text = predictors)))
    m_try_seq <- round(n_preds^((1:7)/8))
    specific_args <- list(trControl = myControl,
                          metric    = "ROC",
                          x         = training_set[predictors],
                          y         = training_set[[outcome]],method = "rf",
                          tuneGrid  = expand.grid(mtry = m_try_seq)) 
  }
  
return(specific_args)
}


model_grid$specific_args <-
  purrr::pmap(
    .l = list(
      model_type = model_grid$model_type,
      outcome    = model_grid$outcome,
      predictors = model_grid$predictors
      ),
    .f = ~ write_arg_list(..1, ..2, ..3)
  )
```


# Creating subsets
(it would be possible to make sure matched pairs are placed in the same fold - we chose not to do this.)

First devide data into a training set and a test set in ratio 3 to 1

```{r}
set.seed(3010)
four_folds <-createFolds(y = analyzed_data$reoffenceThisTerm, k = 4)

test_set     <- analyzed_data[ (1:nrow(analyzed_data) %in% 
                                   four_folds[[4]]), all_variables]
training_set <- analyzed_data[!(1:nrow(analyzed_data) %in% 
                                   four_folds[[4]]), all_variables]

nrow(test_set)
nrow(training_set)


```

Then make 10 sets of 10 folds 
```{r}
# ten_folds_training  <- createFolds(y = training_set$reoffenceThisTerm, k = 10)
# twenty_by_ten_folds <- createMultiFolds(y = training_set$reoffenceThisTerm, k = 10, times = 20)
ten_by_ten_folds <- createMultiFolds(y = training_set$reoffenceThisTerm, k = 10, times = 10)
```


Now set up the cross validation schemes using these folds. 


```{r}

myControl <- trainControl(
  method = "repeatedcv",
  number = 10,
  repeats = 10,
  summaryFunction = twoClassSummary,
  classProbs = TRUE, 
  verboseIter = TRUE,
  savePredictions = "final",
  index = ten_by_ten_folds)
```





Also create functions to do the training with random forest (rf) and elastic net (glmnet) according to our specifications. Building on the 'caret::train' function.

Arguments for the functions:
    +  outcome: the predicted outcome. This is going to be either 
    + "reoffenceThisTerm" for general recidivism
  

```{r}
my_train <- function(outcome, predictors, specific_args) {

   predictors <- eval(parse(text = predictors))  
  
  shared_args <- list(
    x         = training_set[predictors],
    y         = training_set[[outcome]],
    metric    = "ROC",
    trControl = myControl
    )
 
  all_args <- c(shared_args, specific_args[[1]])
  train_list <- do.call(caret::train, args = all_args)
  return(train_list)
    
}


```

Split into subsets of models for easier management
```{r}
glm_grid    <- model_grid %>% filter(model_type == "glm")
glmnet_grid <- model_grid %>% filter(model_type == "glmnet")
rf_grid     <- model_grid %>% filter(model_type == "rf")
```

```{r}
run_all_in_grid <- function(grid_df) {
  arg_list <- list(
    outcome = grid_df$outcome,
    predictors = grid_df$predictors,
    specific_args = grid_df$specific_args
    )
  purrr::pmap(.l = arg_list, 
              .f = ~my_train(..1, ..2, ..3)
              )
}


glm_grid$results <- run_all_in_grid(glm_grid)

```



# Random forest models

```{r}
items_V_rf       <- cv_rf(outcome = "newO_violent", predictors = rita_items, 
                          M = c(2, 3, 4, 5, 24, 27))
facto_V_rf       <- cv_rf(outcome = "newO_violent", predictors = rita_factors, 
                          M = c(1, 2))
stati_V_rf       <- cv_rf(outcome = "newO_violent", predictors = static_preds, 
                          M = c(2, 3, 4, 5))
stati_items_V_rf <- cv_rf(outcome = "newO_violent", 
                                predictors = c(rita_items, static_preds), 
                                               M = c(13, 14, 15, 16, 17, 24, 27))
stati_facto_V_rf <- cv_rf(outcome = "newO_violent", 
                                predictors = c(rita_factors, static_preds), M = c(2, 3, 4, 5))
plus_outcome_V_rf <- cv_rf(outcome = "newO_violent", 
                                predictors = c(rita_factors, static_preds, "openPrison", "conditionalReleaseOutcome"), M = c(2, 3, 4, 5, 8, 12))
plus_outcome_V_rf_i <- cv_rf(outcome = "newO_violent", 
                                predictors = c(rita_items, static_preds, "openPrison", "conditionalReleaseOutcome"), M = c(18:24))


items_G_rf       <- cv_rf(outcome = "reoffenceThisTerm", predictors = rita_items, M = c(4:8))
facto_G_rf       <- cv_rf(outcome = "reoffenceThisTerm", predictors = rita_factors, M = c(1:2))
stati_G_rf       <- cv_rf(outcome = "reoffenceThisTerm", predictors = static_preds, M = c(1:2))
stati_items_G_rf <- cv_rf(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_items, static_preds), M = c(16:20, 24, 27))
stati_facto_G_rf <- cv_rf(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_factors, static_preds), M = c(2, 3, 4, 5))

plus_outcome_G_rf <- cv_rf(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_factors, static_preds, "openPrison", "conditionalReleaseOutcome"), M = c(2, 3, 4, 5, 8, 12))
plus_outcome_G_rf_i <- cv_rf(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_items, static_preds, "openPrison", "conditionalReleaseOutcome"), M = c(2, 13:24, 27))
```

# Elastic net models

```{r}
items_V_glm       <- cv_glmnet(outcome = "newO_violent", predictors = rita_items, A = 0)
facto_V_glm       <- cv_glmnet(outcome = "newO_violent", predictors = rita_factors, 
                               A = c(0.04, 0.05, 0.06, 0.07))
stati_V_glm       <- cv_glmnet(outcome = "newO_violent", predictors = static_preds,
                               A = c(0.09, 0.1, 0.11, 0.15))
stati_items_V_glm <- cv_glmnet(outcome = "newO_violent", 
                                predictors = c(rita_items, static_preds),
                               A = c(0.02, 0.03))
stati_facto_V_glm <- cv_glmnet(outcome = "newO_violent", 
                                predictors = c(rita_factors, static_preds),
                               A = c(0.09, 0.1, 0.11))

items_G_glm       <- cv_glmnet(outcome = "reoffenceThisTerm", predictors = rita_items,
                               A = c(0.06, 0.7, 0.8, 0.9))
facto_G_glm       <- cv_glmnet(outcome = "reoffenceThisTerm", predictors = rita_factors,
                               A = c(0.02, 0.03, 0.04))
stati_G_glm       <- cv_glmnet(outcome = "reoffenceThisTerm", predictors = static_preds,
                               A = c(0.95, 0.99, 1))
stati_items_G_glm <- cv_glmnet(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_items, static_preds),
                               A = c(0.95, 0.99, 1))
stati_facto_G_glm <- cv_glmnet(outcome = "reoffenceThisTerm", 
                                predictors = c(rita_factors, static_preds),
                               A = c(0.95, 0.99, 1))
```

# Place models in a list and save them

```{r}
model_list_rf <-   list(items_V_rf       = items_V_rf,
                        facto_V_rf       = facto_V_rf,
                        stati_V_rf       = stati_V_rf,
                        stati_items_V_rf = stati_items_V_rf,
                        stati_facto_V_rf = stati_facto_V_rf,
                        
                        items_G_rf       = items_G_rf,
                        facto_G_rf       = facto_G_rf,
                        stati_G_rf       = stati_G_rf,
                        stati_items_G_rf = stati_items_G_rf,
                        stati_facto_G_rf = stati_facto_G_rf)

saveRDS(model_list_rf, "C:/Users/benny_000/Dropbox/AAAKTUELLT/manus2/model_list_rf.rds")

model_list_glm <-  list(items_V_glm       = items_V_glm,
                        facto_V_glm       = facto_V_glm,
                        stati_V_glm       = stati_V_glm,
                        stati_items_V_glm = stati_items_V_glm,
                        stati_facto_V_glm = stati_facto_V_glm,

                        items_G_glm       = items_G_glm,
                        facto_G_glm       = facto_G_glm,
                        stati_G_glm       = stati_G_glm,
                        stati_items_G_glm = stati_items_G_glm,
                        stati_facto_G_glm = stati_facto_G_glm
                        )

saveRDS(model_list_glm, "C:/Users/benny_000/Dropbox/AAAKTUELLT/manus2/model_list_glm.rds")
```

